# SpringCache

## 1. ç®€è¿°

&emsp;&emsp;ä¸ºå„ä¸ªç¼“å­˜æŠ€æœ¯æä¾›ä¸€ä¸ªæ¥å£è§„èŒƒã€‚
&emsp;&emsp;å…¶ä¸­CacheManageræ˜¯Springæä¾›çš„å„ç§ç¼“å­˜æŠ€æœ¯æŠ½è±¡æ¥å£ï¼ŒCacheæ¥å£åˆ™æä¾›ç¼“å­˜çš„ç›¸å…³æ“ä½œã€‚

ğŸ”¹SpringBootä¸­çš„æ•´åˆï¼š
&emsp;&emsp;åœ¨Springbootä¸­åˆ™é»˜è®¤é…ç½®äº†å¤šä¸ªCacheManagerçš„å®ç°ï¼Œåœ¨é…ç½®ç±»ä¸­æ·»åŠ @EnabelCachingå³å¯å¼€å¯ç¼“å­˜ï¼Œé»˜è®¤ä½¿ç”¨ConcurrenMapCacheManagerã€‚
&emsp;&emsp;è‹¥ä½¿ç”¨å¤šä¸ªCacheManageråˆ™å¯é€šè¿‡æ³¨å…¥å®ç°CachingConfigurerSupportæ¥å£çš„é…ç½®ç±»æ¥è®¾ç½®ã€‚

## 2. ç»“åˆRedis

### 2.1. é¡¹ç›®çš„åˆ›å»º

![cahce/20200604200643](https://jianxi-md-pics.oss-cn-beijing.aliyuncs.com/note-md-imgs/cahce/20200604200643.png?x-oss-process=image/resize,p_100/sharpen,50)

### 2.1. ä½¿ç”¨redis

#### 2.1.1. åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®åŸºæœ¬ä¿¡æ¯

```properties

//redisçš„ç›¸å…³é…ç½®
spring.redis.host=106.15.72.132
spring.redis.port=6379
spring.redis.database=0
spring.redis.password=
//è®¾ç½®cahceåç§°
spring.cache.cache-names=c1

```

#### 2.1.2. ä½¿ç”¨ç¼“å­˜

åœ¨å°†è¿ç”¨ç¼“å­˜çš„æ–¹æ³•æˆ–ç±»ä¸Šæ·»åŠ ç›¸åº”çš„æ³¨è§£

#### @EnableCaching

åœ¨å¯åŠ¨ç±»æ³¨è§£@EnableCachingå¼€å¯ç¼“å­˜

#### @Cacheable

æ ‡è®°å“ªä¸ªæ–¹æ³•å°†ä½¿ç”¨ç¼“å­˜ã€‚
é»˜è®¤æ–¹æ³•æ‰€æœ‰æ–¹æ³•ä¸ºkey,è¿”å›å€¼ä¸ºvalueã€‚

ä¸»è¦å‚æ•°å¦‚ä¸‹ï¼š

ğŸ”¹ cacheName
æŒ‡å®šç¼“å­˜åç§°

ğŸ”¹ key
æŒ‡å®šå“ªäº›å†…å®¹ä½œä¸ºç¼“å­˜çš„keyï¼ˆé»˜è®¤ä¸ºæ–¹æ³•çš„æ‰€æœ‰å‚æ•°ï¼‰
|å–å€¼|å«ä¹‰|æ¡ˆä¾‹|
|-|-|-|
|å‚æ•°å|è¡¨ç¤ºæŸä¸ªå‚æ•°||
|method|è¯¥æ–¹æ³•|[[method]]ã€[[method]].name|
|methodName|æ–¹æ³•åç§°|[[methodName]]|
|args|æ–¹æ³•å‚æ•°|[[args]]ã€[[args]][0]|
|target|å½“å‰è¢«è°ƒç”¨çš„class|[[target]]|
|caches|è¢«è°ƒç”¨çš„æ–¹æ³•ä½¿ç”¨çš„ç¼“å­˜|[[caches]]|
|result|æ–¹æ³•è¿”å›å€¼ï¼ˆéœ€å…ˆæ‰§è¡Œæ–¹æ³•ï¼‰|[[result]]|
|condition|ç¼“å­˜æ·»åŠ ï¼Œtrueæ—¶æ‰è¿›è¡Œç¼“å­˜,ä½¿ç”¨SpEL|[[userName]].length()>2|

```java
// æ¡ˆä¾‹ï¼šæŒ‡å®šå‚æ•°åä¸ºidçš„å€¼ä½œä¸ºkey
@Cacheable(cacheNames = "c1",key = "[[id]]")
```

ğŸ”¹ keyGernerator
è‡ªå®šä¹‰key
å…ˆå®šä¹‰ç±»ï¼Œå®ç°KeyGerneratoræ¥å£ï¼Œæ³¨å…¥iocå®¹å™¨ã€‚å†é€šè¿‡è¯¥æ³¨è§£æ¥æŒ‡å®šã€‚

```java

// è‡ªå®šä¹‰å®šä¹‰key
@Component
public class MyKeyGernerator implements KeyGenerator {
    /**
     * è®¾ç½® æ–¹æ³•å-å‚æ•°å ä¸ºkey
     * @param o å½“å‰è¢«è°ƒç”¨çš„å¯¹è±¡
     * @param method æ–¹æ³•
     * @param objects   æ–¹æ³•å‚æ•°
     * @return æ–¹æ³•å+å‚æ•°å
     */
    @Override
    public Object generate(Object o, Method method, Object... objects) {
        return method.getName()+"-"+ Arrays.toString(objects);
    }
}

```

```java
// æŒ‡å®šè‡ªå®šä¹‰çš„key
@Cacheable(cacheNames = "c1",keyGenerator = "myKeyGernerator")
```

#### @CacheEvict

ç”¨äºåˆ é™¤ç¼“å­˜ã€‚

ç‰¹æœ‰çš„å‚æ•°ï¼š
|å‚æ•°|å«ä¹‰|
|-|-|
|allEntries|æ˜¯å¦åˆ é™¤æ‰€æœ‰ç¼“å­˜|
|beforeInvocation|æ˜¯å¦å…ˆè°ƒç”¨ï¼Œå³æ˜¯å¦å…ˆåˆ é™¤ç¼“å­˜|

```java
//æ¡ˆä¾‹
@CacheEvict(cacheNames = "c1",allEntries = false)
public void deleteUserById(Integer id){
    System.out.println(">>>deleteUserById()");
}
```

#### @CachePut

ç”¨äºæ›´æ–°ç¼“å­˜ï¼Œæ›´æ–°keyå€¼ç›¸åŒçš„ç¼“å­˜

```java
@CachePut(cacheNames = "c1",key = "[[user]].id")
public User updateUser(User user){
    System.out.println(">>>updateUser()");
    return user;
}
```

#### @CacheConfig

ç”¨äºç±»ä¸Šçš„æ³¨è§£ï¼Œæ·»åŠ Cacheçš„ç›¸å…³é…ç½®

ç‰¹æœ‰çš„å‚æ•°ï¼š
|å‚æ•°|å«ä¹‰|
|-|-|
|cacheNames|æŒ‡å®šè¯¥ç±»ä¸Šçš„ç¼“å­˜ä½¿ç”¨çš„ç¼“å­˜åç§°|

```java
@CacheConfig(cacheNames = "c1")
```

#### @Caching

å¯ç”¨äºä½¿ç”¨å¤šä¸ªæ³¨è§£,ä¸å…¶å®ƒCacheæ³¨è§£ç»“åˆä½¿ç”¨ã€‚

```java
@Caching(put = {
    @CachePut(value = "user", key = "[[user]].id"),
    @CachePut(value = "user", key = "[[user]].username"),
    @CachePut(value = "user", key = "[[user]].email")
})
public User save(User user) {
    .....
}
```
